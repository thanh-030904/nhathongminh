<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Home IoT Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* HEADER */
        .header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .header h1 {
            color: #667eea;
            font-size: 32px;
            margin-bottom: 10px;
        }

        .status-bar {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin-top: 15px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            background: #4CAF50;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* KH·ªêI 1: D·ªÆ LI·ªÜU REALTIME */
        .data-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .data-card {
            background: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transition: transform 0.3s;
        }

        .data-card:hover {
            transform: translateY(-5px);
        }

        .data-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .data-label {
            font-size: 16px;
            color: #666;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .data-value {
            font-size: 42px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 10px;
        }

        .data-unit {
            font-size: 18px;
            color: #999;
        }

        .alert-badge {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            margin-top: 10px;
        }

        .alert-normal {
            background: #E8F5E9;
            color: #4CAF50;
        }

        .alert-danger {
            background: #FFEBEE;
            color: #F44336;
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        /* KH·ªêI 2: ƒêI·ªÄU KHI·ªÇN THI·∫æT B·ªä */
        .control-section {
            background: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .control-section h2 {
            color: #333;
            margin-bottom: 25px;
            font-size: 24px;
            text-align: center;
        }

        .control-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .control-item {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            transition: all 0.3s;
        }

        .control-item:hover {
            background: #e9ecef;
        }

        .control-icon {
            font-size: 40px;
            margin-bottom: 15px;
        }

        .control-name {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
        }

        /* SWITCH TOGGLE */
        .switch {
            position: relative;
            display: inline-block;
            width: 70px;
            height: 34px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #4CAF50;
        }

        input:checked + .slider:before {
            transform: translateX(36px);
        }

        .status-text {
            margin-top: 10px;
            font-size: 12px;
            font-weight: bold;
            color: #999;
        }

        .status-text.on {
            color: #4CAF50;
        }

        .status-text.off {
            color: #F44336;
        }

        /* KH·ªêI 3: BI·ªÇU ƒê·ªí THINGSPEAK */
        .chart-section {
            background: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .chart-section h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 24px;
            text-align: center;
        }

        /* Fix iframe ThingSpeak full width + height */
.chart-container {
    position: relative;
    width: 100%;
    height: 500px;  /* Chi·ªÅu cao c·ªë ƒë·ªãnh ƒë·∫πp, b·∫°n c√≥ th·ªÉ tƒÉng l√™n 600px ho·∫∑c 700px */
    overflow: hidden;
    border-radius: 10px;
    background: #f8f9fa;
}

.chart-container iframe {
    width: 100% !important;   /* !important ƒë·ªÉ override style n·ªôi t·∫°i c·ªßa ThingSpeak */
    height: 100% !important;  /* !important b·∫Øt bu·ªôc */
    border: none;
    display: block;
}

        /* LOADING SPINNER */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ERROR MESSAGE */
        .error-msg {
            background: #FFEBEE;
            color: #F44336;
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
            display: none;
            text-align: center;
        }

        .error-msg.show {
            display: block;
        }

        /* FOOTER */
        .footer {
            text-align: center;
            color: white;
            margin-top: 30px;
            padding: 20px;
            font-size: 14px;
        }

        /* RESPONSIVE */
        @media (max-width: 768px) {
            .header h1 {
                font-size: 24px;
            }

            .data-value {
                font-size: 32px;
            }

            .control-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- HEADER -->
        <div class="header">
            <h1> SMART HOME </h1>
            <div class="status-bar">
                <div class="status-dot"></div>
                <span></span>
                <span>Last update: <span id="lastUpdate">--:--:--</span></span>
            </div>
        </div>

        <!-- KH·ªêI 1: D·ªÆ LI·ªÜU REALTIME -->
        <div class="data-section">
            <!-- Nhi·ªát ƒë·ªô -->
            <div class="data-card">
                <div class="data-icon">üå°Ô∏è</div>
                <div class="data-label">Temperature</div>
                <div class="data-value">
                    <span id="temperature">--</span>
                </div>
                <div class="data-unit">¬∞C</div>
            </div>

            <!-- ƒê·ªô ·∫©m -->
            <div class="data-card">
                <div class="data-icon">üíß</div>
                <div class="data-label">Humidity</div>
                <div class="data-value">
                    <span id="humidity">--</span>
                </div>
                <div class="data-unit">%</div>
            </div>

            <!-- C·∫£nh b√°o nhi·ªát -->
            <div class="data-card">
                <div class="data-icon">üö®</div>
                <div class="data-label">Fire Alert</div>
                <div class="alert-badge" id="fireAlert">
                    NORMAL
                </div>
            </div>

            <!-- Ph√°t hi·ªán v·∫≠t g·∫ßn -->
            <div class="data-card">
                <div class="data-icon">üìè</div>
                <div class="data-label">Motion Detect</div>
                <div class="alert-badge" id="motionAlert">
                    NO MOTION
                </div>
            </div>
        </div>

        <!-- KH·ªêI 2: ƒêI·ªÄU KHI·ªÇN THI·∫æT B·ªä -->
        <div class="control-section">
            <h2></h2>
            <div class="control-grid">
                <!-- LED 1 -->
                <div class="control-item">
                    <div class="control-icon">üí°</div>
                    <div class="control-name">LED 1</div>
                    <label class="switch">
                        <input type="checkbox" id="led1" onchange="controlDevice('led1', 'V1', this.checked)">
                        <span class="slider"></span>
                    </label>
                    <div class="status-text off" id="led1Status">OFF</div>
                </div>

                <!-- LED 2 -->
                <div class="control-item">
                    <div class="control-icon">üí°</div>
                    <div class="control-name">LED 2</div>
                    <label class="switch">
                        <input type="checkbox" id="led2" onchange="controlDevice('led2', 'V2', this.checked)">
                        <span class="slider"></span>
                    </label>
                    <div class="status-text off" id="led2Status">OFF</div>
                </div>

                <!-- LED 3 -->
                <div class="control-item">
                    <div class="control-icon">üí°</div>
                    <div class="control-name">LED 3</div>
                    <label class="switch">
                        <input type="checkbox" id="led3" onchange="controlDevice('led3', 'V3', this.checked)">
                        <span class="slider"></span>
                    </label>
                    <div class="status-text off" id="led3Status">OFF</div>
                </div>

                <!-- Qu·∫°t -->
                <div class="control-item">
                    <div class="control-icon">üåÄ</div>
                    <div class="control-name">FAN</div>
                    <label class="switch">
                        <input type="checkbox" id="fan" onchange="controlDevice('fan', 'V9', this.checked)">
                        <span class="slider"></span>
                    </label>
                    <div class="status-text off" id="fanStatus">OFF</div>
                </div>
            </div>

            <!-- Error message -->
            <div class="error-msg" id="errorMsg">
                ‚ö†Ô∏è Kh√¥ng k·∫øt n·ªëi ƒë∆∞·ª£c Blynk. Vui l√≤ng ki·ªÉm tra token!
            </div>
        </div>

        <!-- KH·ªêI 3: BI·ªÇU ƒê·ªí THINGSPEAK -->
        <div class="chart-section">
            <h2>DATA CHARTS </h2>
            
            <!-- Chart Nhi·ªát ƒë·ªô -->
            <div class="chart-container">
                <h3 style="text-align: center; color: #666; margin-bottom: 15px;">Temperature Chart</h3>
                <iframe id="tempChart" src=""></iframe>
            </div>

            <!-- Chart ƒê·ªô ·∫©m -->
            <div class="chart-container" style="margin-top: 20px;">
                <h3 style="text-align: center; color: #666; margin-bottom: 15px;">Humidity Chart</h3>
                <iframe id="humChart" src=""></iframe>
            </div>
        </div>

        <!-- FOOTER -->
        <div class="footer">
            <p><strong>IoT Final Project - Server Room Monitoring System</strong></p>
            <p>ESP32-S3 | DHT20 | SRF05 | Blynk Cloud | ThingSpeak</p>
            <p>¬© 2024 - Smart Home Dashboard</p>
        </div>
    </div>

    <script>
        // ============================================
        // C·∫§U H√åNH API (THAY ƒê·ªîI ·ªû ƒê√ÇY)
        // ============================================
        
        const CONFIG = {
            // BLYNK
            BLYNK_TOKEN: "TSH9w7JkOJzkAx6__5YYBXmwbZHwoaeU",
            BLYNK_API: "https://blynk.cloud/external/api",
            
            // THINGSPEAK (THAY ƒê·ªîI CHANNEL_ID C·ª¶A B·∫†N)
            THINGSPEAK_CHANNEL: "3218420",  // ‚Üê THAY ƒê√ÇY
            
            // C·∫¨P NH·∫¨T DATA (milliseconds)
            UPDATE_INTERVAL: 5000  // 5 gi√¢y
        };

        // ============================================
        // KH·ªûI T·∫†O THINGSPEAK CHARTS
        // ============================================
        
        function initCharts() {
            const channelId = CONFIG.THINGSPEAK_CHANNEL;
            
            // Chart nhi·ªát ƒë·ªô (field1)
            document.getElementById('tempChart').src = 
                `https://thingspeak.com/channels/${channelId}/charts/1?bgcolor=%23ffffff&color=%23d62020&dynamic=true&results=60&type=line&width=1200&height=450`;
            
            // Chart ƒë·ªô ·∫©m (field2)
            document.getElementById('humChart').src = 
                `https://thingspeak.com/channels/${channelId}/charts/2?bgcolor=%23ffffff&color=%232020d6&dynamic=true&results=60&type=line&width=1200&height=450`;
        }

        // ============================================
        // ƒê·ªåC D·ªÆ LI·ªÜU T·ª™ BLYNK
        // ============================================
        
        async function readBlynkData(virtualPin) {
            try {
                const url = `${CONFIG.BLYNK_API}/get?token=${CONFIG.BLYNK_TOKEN}&${virtualPin}`;
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.text();
                return parseFloat(data);
            } catch (error) {
                console.error(`Error reading ${virtualPin}:`, error);
                return null;
            }
        }

        // ============================================
        // C·∫¨P NH·∫¨T D·ªÆ LI·ªÜU L√äN GIAO DI·ªÜN
        // ============================================
        
        async function updateSensorData() {
            // 1. Nhi·ªát ƒë·ªô (V6)
            const temp = await readBlynkData('V6');
            if (temp !== null) {
                document.getElementById('temperature').textContent = temp.toFixed(1);
            }

            // 2. ƒê·ªô ·∫©m (V7)
            const hum = await readBlynkData('V7');
            if (hum !== null) {
                document.getElementById('humidity').textContent = hum.toFixed(1);
            }

            // 3. C·∫£nh b√°o nhi·ªát ƒë·ªô (V10)
            const fireAlert = await readBlynkData('V10');
            const fireElement = document.getElementById('fireAlert');
            if (fireAlert === 1) {
                fireElement.textContent = 'üî• DANGER!';
                fireElement.className = 'alert-badge alert-danger';
            } else {
                fireElement.textContent = '‚úÖ NORMAL';
                fireElement.className = 'alert-badge alert-normal';
            }

            // 4. Ph√°t hi·ªán v·∫≠t g·∫ßn (V8)
            const motion = await readBlynkData('V8');
            const motionElement = document.getElementById('motionAlert');
            if (motion === 1) {
                motionElement.textContent = 'üë§ DETECTED!';
                motionElement.className = 'alert-badge alert-danger';
            } else {
                motionElement.textContent = '‚úÖ NO MOTION';
                motionElement.className = 'alert-badge alert-normal';
            }

            // C·∫≠p nh·∫≠t th·ªùi gian
            const now = new Date();
            document.getElementById('lastUpdate').textContent = 
                now.toLocaleTimeString('vi-VN');
        }

        // ============================================
        // ƒêI·ªÄU KHI·ªÇN THI·∫æT B·ªä (GHI D·ªÆ LI·ªÜU L√äN BLYNK)
        // ============================================
        
        async function controlDevice(deviceName, virtualPin, state) {
            try {
                const value = state ? 1 : 0;
                const url = `${CONFIG.BLYNK_API}/update?token=${CONFIG.BLYNK_TOKEN}&${virtualPin}=${value}`;
                
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error('Blynk API error');
                }

                // C·∫≠p nh·∫≠t status text
                const statusElement = document.getElementById(`${deviceName}Status`);
                if (state) {
                    statusElement.textContent = 'ON';
                    statusElement.className = 'status-text on';
                } else {
                    statusElement.textContent = 'OFF';
                    statusElement.className = 'status-text off';
                }

                console.log(`${deviceName} turned ${state ? 'ON' : 'OFF'}`);
                
                // ·∫®n error message n·∫øu c√≥
                document.getElementById('errorMsg').classList.remove('show');
                
            } catch (error) {
                console.error('Control error:', error);
                
                // Hi·ªÉn th·ªã error
                document.getElementById('errorMsg').classList.add('show');
                
                // Reset switch v·ªÅ tr·∫°ng th√°i c≈©
                document.getElementById(deviceName).checked = !state;
            }
        }

        // ============================================
        // ƒê·ªåC TR·∫†NG TH√ÅI THI·∫æT B·ªä T·ª™ BLYNK
        // ============================================
        
        async function syncDeviceStates() {
            const devices = [
                { id: 'led1', pin: 'V1' },
                { id: 'led2', pin: 'V2' },
                { id: 'led3', pin: 'V3' },
                { id: 'fan', pin: 'V9' }
            ];

            for (const device of devices) {
                const state = await readBlynkData(device.pin);
                if (state !== null) {
                    const checkbox = document.getElementById(device.id);
                    const statusElement = document.getElementById(`${device.id}Status`);
                    
                    checkbox.checked = (state === 1);
                    
                    if (state === 1) {
                        statusElement.textContent = 'ON';
                        statusElement.className = 'status-text on';
                    } else {
                        statusElement.textContent = 'OFF';
                        statusElement.className = 'status-text off';
                    }
                }
            }
        }

        // ============================================
        // KH·ªûI ƒê·ªòNG H·ªÜ TH·ªêNG
        // ============================================
        
        window.onload = function() {
            console.log('üöÄ IoT Dashboard Started');
            console.log('Blynk Token:', CONFIG.BLYNK_TOKEN);
            console.log('ThingSpeak Channel:', CONFIG.THINGSPEAK_CHANNEL);
            
            // Kh·ªüi t·∫°o charts
            initCharts();
            
            // ƒê·ªçc d·ªØ li·ªáu l·∫ßn ƒë·∫ßu
            updateSensorData();
            syncDeviceStates();
            
            // C·∫≠p nh·∫≠t ƒë·ªãnh k·ª≥
            setInterval(updateSensorData, CONFIG.UPDATE_INTERVAL);
            setInterval(syncDeviceStates, CONFIG.UPDATE_INTERVAL * 2); // 10 gi√¢y
            
            console.log('‚úÖ System Ready');
        };

        // ============================================
        // X·ª¨ L√ù L·ªñI TO√ÄN C·ª§C
        // ============================================
        
        window.onerror = function(msg, url, lineNo, columnNo, error) {
            console.error('Error:', msg, 'at', url, ':', lineNo);
            document.getElementById('errorMsg').textContent = 
                '‚ö†Ô∏è C√≥ l·ªói x·∫£y ra. Vui l√≤ng ki·ªÉm tra Console (F12)';
            document.getElementById('errorMsg').classList.add('show');
            return false;
        };
    </script>
</body>
</html>
